<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Asignar mi rol — GL CBC</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0b0f14; color:#e7edf3; margin:0; }
    .wrap { max-width:520px; margin:40px auto; padding:0 16px; }
    .card { background:#121821; border:1px solid #1d2733; border-radius:12px; padding:16px; box-shadow:0 6px 24px rgba(0,0,0,.24); }
    label, select, button { display:block; width:100%; margin-top:10px; }
    select, button { padding:10px 12px; border-radius:10px; border:1px solid #2a394b; background:#233142; color:#e7edf3; }
    button:hover { filter:brightness(1.08); cursor:pointer; }
    .muted { opacity:.8; font-size:.95rem; }
    .ok { color:#9ae6b4; margin-top:10px; }
    .err { color:#feb2b2; margin-top:10px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>Asignar mi rol</h2>
      <p class="muted">Debes estar <strong>logueado</strong>. Esto solo cambia <em>tu</em> perfil.</p>

      <label for="role">Selecciona tu rol</label>
      <select id="role">
        <option>Socio Fundador</option>
        <option>Socio Mayorista</option>
        <option>Socio</option>
        <option>Asociado</option>
        <option>Abogado Asociado</option>
        <option>Cliente</option>
      </select>

      <button id="save">Guardar rol</button>
      <p id="msg"></p>

      <p class="muted" style="margin-top:14px">
        Tu correo: <span id="email">—</span><br/>
        Rol actual: <span id="current">—</span>
      </p>

      <p style="margin-top:14px">
        <a href="dashboard.html">Ir al dashboard</a> ·
        <a href="login.html">Volver a login</a>
      </p>
    </div>
  </div>

  <!-- Carga la CDN y tu app.js para reutilizar el cliente "sb" -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="app.js"></script>
  <script>
    (async () => {
      // Exige sesión
      const { data: { session } } = await sb.auth.getSession();
      if (!session) { window.location.href = 'login.html'; return; }

      // Muestra email y rol actual
      const { data: { user } } = await sb.auth.getUser();
      document.getElementById('email').textContent = user?.email || '—';
      const current = user?.user_metadata?.role ?? (Array.isArray(user?.user_metadata?.roles) ? user.user_metadata.roles.join(', ') : '—');
      document.getElementById('current').textContent = current || '—';

      // Guardar nuevo rol
      document.getElementById('save').onclick = async () => {
        const role = document.getElementById('role').value;
        document.getElementById('msg').textContent = 'Guardando…';
        document.getElementById('msg').className = '';

        const { error } = await sb.auth.updateUser({ data: { role } });
        if (error) {
          document.getElementById('msg').textContent = 'Error: ' + error.message;
          document.getElementById('msg').className = 'err';
          return;
        }
        document.getElementById('msg').textContent = '✅ Rol actualizado a: ' + role;
        document.getElementById('msg').className = 'ok';
        document.getElementById('current').textContent = role;
      };
    })();
  </script>
</body>
</html>
