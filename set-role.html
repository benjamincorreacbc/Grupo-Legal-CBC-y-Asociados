<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Asignar mi rol — GL CBC</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0b0f14; color:#e7edf3; margin:0; }
    .wrap { max-width:520px; margin:40px auto; padding:0 16px; }
    .card { background:#121821; border:1px solid #1d2733; border-radius:12px; padding:16px; box-shadow:0 6px 24px rgba(0,0,0,.24); }
    label, select, button { display:block; width:100%; margin-top:10px; }
    select, button { padding:10px 12px; border-radius:10px; border:1px solid #2a394b; background:#233142; color:#e7edf3; }
    button:hover { filter:brightness(1.08); cursor:pointer; }
    .muted { opacity:.8; font-size:.95rem; }
    .ok { color:#9ae6b4; margin-top:10px; }
    .err { color:#feb2b2; margin-top:10px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>Asignar mi rol</h2>
      <p class="muted">Debes estar <strong>logueado</strong>. Esto solo cambia <em>tu</em> perfil.</p>

      <label for="role">Selecciona tu rol</label>
      <select id="role">
        <option>Admin</option>
        <option>Socio Fundador</option>
        <option>Socio Mayorista</option>
        <option>Socio</option>
        <option>Asociado</option>
        <option>Abogado Asociado</option>
        <option>Cliente</option>
      </select>

      <button id="save">Guardar rol</button>
      <p id="msg"></p>

      <p class="muted" style="margin-top:14px">
        Tu correo: <span id="email">—</span><br/>
        Rol actual: <span id="current">—</span>
      </p>

      <p style="margin-top:14px">
        <a href="dashboard.html">Ir al dashboard</a> ·
        <a href="login.html">Volver a login</a>
      </p>
    </div>
  </div>

  <script src="config.js"></script>
  <script type="module">
    import { supabase, requireSessionOrRedirect } from './js/auth.js';

    const ROLE_MAP = {
      'Admin': 'admin',
      'Socio Fundador': 'socio_fundador',
      'Socio Mayorista': 'socio_mayorista',
      'Socio': 'socio',
      'Asociado': 'asociado',
      'Abogado Asociado': 'abogado_asociado',
      'Cliente': 'cliente',
    };
    const LABEL_MAP = Object.fromEntries(Object.entries(ROLE_MAP).map(([label, value]) => [value, label]));
    const API_BASE = window.__GLCBC_API_BASE__;

    const session = await requireSessionOrRedirect('./login.html');
    const { data: { user } } = await supabase.auth.getUser();
    const emailEl = document.getElementById('email');
    const currentEl = document.getElementById('current');
    const select = document.getElementById('role');
    const msg = document.getElementById('msg');

    emailEl.textContent = user?.email ?? '—';
    const currentRole = user?.user_metadata?.role || 'cliente';
    const currentLabel = Object.entries(ROLE_MAP).find(([, value]) => value === currentRole)?.[0] || 'Cliente';
    currentEl.textContent = currentRole;
    select.value = currentLabel;

    document.getElementById('save').onclick = async () => {
      msg.textContent = 'Guardando…'; msg.className = '';
      try {
        const selectedLabel = select.value;
        const role = ROLE_MAP[selectedLabel] || 'cliente';
        const updateUser = await supabase.auth.updateUser({ data: { role } });
        if (updateUser.error) throw new Error(updateUser.error.message);

        const jwt = session?.access_token;
        const res = await fetch(API_BASE, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${jwt}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ action: 'set_role', role }),
        });
        const json = await res.json();
        if (!res.ok) throw new Error(json?.error || 'No se pudo actualizar tu rol en servidor');

        msg.textContent = `✅ Rol actualizado a: ${role}`; msg.className = 'ok';
        currentEl.textContent = role;
      } catch (error) {
        console.error(error);
        msg.textContent = error.message || 'No se pudo guardar el rol'; msg.className = 'err';
      }
    };
  </script>
</body>
</html>
